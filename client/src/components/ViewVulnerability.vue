<template>
  <panel :title="vulnerability.title">
    <v-btn
      slot="action"
      light
      medium
      absolute
      left
      middle
      fab
      router
      to="/vulnerabilities"
      ><v-icon>arrow_back</v-icon></v-btn
    >

    <slot>
      <!-- <div v-for="(service, index) in dataApiCert.CVE_Items" :key="index">{{service.impact.baseMetricV2.severity}}</div> -->
      <v-simple-table fixed-header height="600px" widtd="5000px">
        <template v-slot:default>
          <thead>
            <tr>
              <th class="text-left text-center">Vulnerability nÂ°</th>
              <th class="text-left text-center">Description</th>
              <th class="text-right text-center">Release Date</th>
              <th class="text-right text-center">Severity</th>
              <th class="text-right text-center">Attack complexity</th>
              <th class="text-right text-center width: 15px">URL</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(service, index) in dataApiCert.CVE_Items" :key="index">
              <td class="text-center">{{ index + 1 }}</td>
              <td class="text-center">
                {{
                  service.cve.description.description_data.__ob__.value[0].value
                }}
              </td>
              <td>{{ service.publishedDate | subStr }}</td>
              <td v-if="service.hasOwnProperty('impact')">{{service.impact.baseMetricV2.severity}}</td>
              <td v-else>{{NoDataAvailable}}</td>
              <td v-if="('baseMetricV2' in service)">ya</td>
              <!-- <td v-if="isAvailable(service)">{{dataAvailable}}</td> -->
              <!-- <td v-if="(service.hasOwnProperty('impact'))">coucou</td> -->
              <!-- <td v-else>{{service.impact.baseMetricV2}}ya pas</td> -->
              <td></td>
              <td style="text-align: center;">
                <div
                  v-for="(url, n) in service.cve.references.reference_data"
                  :key="n"
                    class="urllink"
                    
                    @click="goToExternalPage(service)"
                  >
                    {{ url.url }}
                  
                </div>
              </td>

              <!-- <td></td>
              <td>blabla</td>
               <td>{{service.impact.baseMetricV3.cvssV2.attackComplexity}}</td>
              >-->

              <!-- <td v-for="(item, key) in service.cve.description.description_data.__ob__.value[0].value" :key="key">{{item}}</td> -->
            </tr>
          </tbody>
        </template>
      </v-simple-table>
    </slot>
  </panel>
</template>

<script>
import VulnerabilitiesService from "@/services/VulnerabilitiesService";
import Panel from "@/components/Panel.vue";

export default {
  data() {
    return {
      vulnerability: {},
      dataApiCert: {},
      params: "",
      severity: null,
      testurl: " ",
      NoDataAvailable: "No Data Found"
    };
  },
  components: {
    Panel,
  },
  computed: {},
  methods: {
    async getApi() {
      var myHeaders = new Headers();

      var myInit = {
        method: "GET",
        headers: myHeaders,
        mode: "cors",
        cache: "default",
      };
      const url = `https://services.nvd.nist.gov/rest/json/cves/1.0/?keyword=${this.params}`;
      const res = await fetch(url, myInit);
      const results = await res.json();
      this.dataApiCert = results.result;
      console.log("dataApiCert :", this.dataApiCert);
    },
    goToExternalPage(service) {
      window.open(`${service.cve.references.reference_data[0].url}`, "_blank");
      console.log("refe", service.cve.references.reference_data[0]);
    },
  },
  
  async mounted() {
    const vulnerabilityId = this.$store.state.route.params.vulnerabilityId;
    this.vulnerability = (
      await VulnerabilitiesService.show(vulnerabilityId)
    ).data;
    this.params = this.vulnerability.title;
  },
  updated() {
    this.getApi();
  },
  filters: {
    subStr(value) {
      return (
        value.substring(8, 10) +
        "/" +
        value.substring(5, 7) +
        "/" +
        value.substring(0, 4)
      );
    },
  },
};
</script>

<style>
.urllink {
  color: blue;
  
}
.urllink:hover {
  cursor: pointer;
  text-decoration: underline;
}
</style>