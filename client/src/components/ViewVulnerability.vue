<template>
  <panel :title="vulnerability.title">
    <v-btn
      slot="action"
      light
      medium
      absolute
      left
      middle
      fab
      router
      to="/vulnerabilities"
      ><v-icon>arrow_back</v-icon></v-btn>

    <slot v-if="loading">  <v-container style="height: 400px;">
      <v-row
        class="fill-height"
        align-content="center"
        justify="center"
      >
        <v-col
          class="subtitle-1 text-center"
          cols="12"
        >
          Getting your data
        </v-col>
        <v-col cols="6">
          <v-progress-linear
            color="red lighten-1"
            indeterminate
            rounded
            height="6"
          ></v-progress-linear>
        </v-col>
      </v-row>
    </v-container></slot>
    <slot v-if="!loading">
  <slot v-if="typeof dataApiCert === 'undefined'">
    <div><v-alert  color="red"
  elevation="24"
  type="error"><v-row align="center">
        <v-col class="grow">
         No results found with : {{this.params}}
        </v-col>
        <v-col class="shrink">
          <v-btn  to="/vulnerabilities">Go back</v-btn>
        </v-col>
      </v-row></v-alert></div>
  </slot>
    <slot v-else>
      <!-- <div v-for="(service, index) in dataApiCert.CVE_Items" :key="index">{{service.impact.baseMetricV2.severity}}</div> -->
      <v-simple-table fixed-header height="600px" widtd="5000px">
        <template v-slot:default>
          <thead>
            <tr>
              <th class="text-left text-center">Vulnerability nÂ°</th>
              <th class="text-left text-center">Description</th>
              <th class="text-right text-center">Release Date</th>
              <th class="text-right text-center">Severity</th>
              <th class="text-right text-center width: 15px">URL</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(service, index) in dataApiCert.CVE_Items" :key="index">
              <td class="text-center">{{ index + 1 }}</td>
              <td class="text-center">
                {{
                  service.cve.description.description_data.__ob__.value[0].value
                }}
              </td>
              <td>{{ service.publishedDate | subStr }}</td>
              <td v-if="service.hasOwnProperty('impact')">{{service.impact.baseMetricV2.severity}}</td>
              <td v-else>{{NoDataAvailable}}</td>
              <!-- <td v-if="isAvailable(service)">{{dataAvailable}}</td> -->
              <!-- <td v-if="(service.hasOwnProperty('impact'))">coucou</td> -->
              <!-- <td v-else>{{service.impact.baseMetricV2}}ya pas</td> -->
              <td style="text-align: center;">
                <div
                  v-for="(url, n) in service.cve.references.reference_data"
                  :key="n"
                    class="urllink"
                    
                    @click="goToExternalPage(service)"
                  >
                    {{ url.url }}
                  
                </div>
              </td>

              <!-- <td></td>
              <td>blabla</td>
               <td>{{service.impact.baseMetricV3.cvssV2.attackComplexity}}</td>
              >-->

              <!-- <td v-for="(item, key) in service.cve.description.description_data.__ob__.value[0].value" :key="key">{{item}}</td> -->
            </tr>
          </tbody>
        </template>
      </v-simple-table>
    </slot>
    </slot>
  </panel>
 
</template>

<script>
import VulnerabilitiesService from "@/services/VulnerabilitiesService";
import Panel from "@/components/Panel.vue";


export default {
  data() {
    return {
      vulnerability: {},
      dataApiCert: {},
      loading: true,
      params: "",
      severity: null,
      testurl: true,
      NoDataAvailable: "No Data Found",
      test: null,


    };
  },
  components: {
  
    Panel,
  },
  computed: {},
  methods: {
    async getApi() {
      var myHeaders = new Headers();

      var myInit = {
        method: "GET",
        headers: myHeaders,
        mode: "cors",
        cache: "default",
      };
      try{
      const url = `https://services.nvd.nist.gov/rest/json/cves/1.0/?keyword=${this.params}`;
      const res = await fetch(url, myInit);
      const results = await res.json();
      this.dataApiCert = results.result;
      console.log("dataApiCert :", this.dataApiCert);
      this.test = true
      this.loading = false;
      }catch(err){
        this.test = false
      }
      
    },
    goToExternalPage(service) {
      window.open(`${service.cve.references.reference_data[0].url}`, "_blank");
      console.log("refe", service.cve.references.reference_data[0]);
    },
  },
  
  async mounted() {
    const vulnerabilityId = this.$store.state.route.params.vulnerabilityId;
    this.vulnerability = (
      await VulnerabilitiesService.show(vulnerabilityId)
    ).data;
    this.params = this.vulnerability.title;
  },
  updated() {
    this.getApi();
  },
  filters: {
    subStr(value) {
      return (
        value.substring(8, 10) +
        "/" +
        value.substring(5, 7) +
        "/" +
        value.substring(0, 4)
      );
    },
  },
};
</script>

<style>
.urllink {
  color: blue;
  
}
.urllink:hover {
  cursor: pointer;
  text-decoration: underline;
}
.v-progress-circular {
  margin: 1rem;
}
</style>